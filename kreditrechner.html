<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kreditrechner – Laufzeit + gewünschte Tilgung</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --panel2:#0e141c; --text:#e8eef7; --muted:#9fb2c7; --border:#223040; --accent:#4ea1ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: linear-gradient(180deg, var(--bg), #0d131b 50%, var(--bg)); color: var(--text); }
    .wrap { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    .box { background: radial-gradient(1200px 400px at -10% -30%, rgba(78,161,255,0.06), transparent 60%), linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    h1 { margin:0 0 12px; }
    label { display:block; font-size:13px; color: var(--muted); margin: 8px 0 6px; }
    input { width:100%; padding:10px 12px; background:#0b1017; color:var(--text); border:1px solid var(--border); border-radius:10px; }
    .row { display:grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    @media(max-width: 980px){ .row { grid-template-columns: 1fr 1fr 1fr; } }
    @media(max-width: 620px){ .row { grid-template-columns: 1fr; } }
    .btn { display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius: 12px; border:1px solid var(--border); background:#0c121a; color:var(--text); cursor:pointer; }
    .btn.primary { background: linear-gradient(180deg, #1e6fff, #0b57d0); border-color:#134aaf; }
    .btn.alt { background: linear-gradient(180deg, #19c37d, #0ea56a); border-color:#08945e; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    @media(max-width: 980px){ .grid2 { grid-template-columns: 1fr; } }
    .kpi { background:#0b1017; border:1px solid var(--border); border-radius:14px; padding:12px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-weight:700; font-size: 18px; margin-top: 6px; }
    .section { margin-top: 14px; }
    .table-wrap { max-height: 460px; overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:12px; }
    table { width:100%; border-collapse: collapse; }
    thead th { position: sticky; top:0; background:#0b1017; }
    th,td { text-align: right; border-bottom:1px solid #112030; padding:8px 10px; font-variant-numeric: tabular-nums; }
    th:first-child, td:first-child { text-align:left; }
    .muted { color: var(--muted); font-size: 12px; }
    .row-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <h1>Kreditrechner – Laufzeit + gewünschte Tilgung</h1>
      <div class="row">
        <div>
          <label>Kreditbetrag</label>
          <input id="principal" type="number" min="0" step="0.01" placeholder="z. B. 200000">
        </div>
        <div>
          <label>Zinssatz p.a. in %</label>
          <input id="rate" type="number" min="0" step="0.0001" placeholder="z. B. 3.5">
        </div>
        <div>
          <label>Laufzeit in Monaten</label>
          <input id="months" type="number" min="1" step="1" placeholder="z. B. 120">
        </div>
        <div>
          <label>Gewünschter Tilgungssatz p.a. in %</label>
          <input id="tilgPct" type="number" min="0" step="0.0001" placeholder="z. B. 2.0">
        </div>
        <div>
          <label>Startmonat optional</label>
          <input id="start" type="month">
        </div>
      </div>

      <div class="row-actions">
        <button class="btn primary" id="calcBtn" type="button">Berechnen</button>
        <button class="btn alt" id="applyReqBtn" type="button" disabled>Benötigte Rate übernehmen</button>
        <span class="muted">Mit gewünschtem Tilgungssatz kann eine Restschuld nach der Laufzeit bleiben. Der Button setzt die benötigte Rate für 0 Restschuld.</span>
      </div>

      <div class="grid2">
        <div class="kpi"><div class="label">Rate laut gewünschtem Tilgungssatz</div><div class="value" id="kpiRateTilg">–</div></div>
        <div class="kpi"><div class="label">Restschuld nach Laufzeit bei dieser Rate</div><div class="value" id="kpiRest">–</div></div>
        <div class="kpi"><div class="label">Benötigte Rate für 0 Restschuld in der Laufzeit</div><div class="value" id="kpiRateReq">–</div></div>
        <div class="kpi"><div class="label">Differenz pro Monat</div><div class="value" id="kpiDelta">–</div></div>
        <div class="kpi"><div class="label">Impliziter Anfangstilgungssatz der benötigten Rate</div><div class="value" id="kpiImplTilg">–</div></div>
        <div class="kpi"><div class="label">Gesamtzinsen bei benötigter Rate</div><div class="value" id="kpiIntReq">–</div></div>
      </div>

      <div class="section">
        <div class="muted">Tabelle A: Plan mit gewünschtem Tilgungssatz (endet nach N Monaten, ggf. mit Restschuld)</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Periode</th><th>Datum</th><th>Rate</th><th>Zinsanteil</th><th>Tilgung</th><th>Restschuld</th></tr></thead>
            <tbody id="tbodyA"></tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <div class="muted">Tabelle B: Plan mit benötigter Rate (endet auf 0 Restschuld)</div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Periode</th><th>Datum</th><th>Rate</th><th>Zinsanteil</th><th>Tilgung</th><th>Restschuld</th></tr></thead>
            <tbody id="tbodyB"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const EURO = new Intl.NumberFormat('de-DE', { style:'currency', currency:'EUR' });
  function fmtEUR(n){ return EURO.format(n); }
  const fmtMonth = new Intl.DateTimeFormat('de-DE', { year:'numeric', month:'2-digit' });

  function toMonthStart(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function addMonths(d, n){ const x = new Date(d); x.setMonth(x.getMonth()+n); return toMonthStart(x); }

  function parseNum(x){
    if (x == null) return null;
    if (typeof x === 'number') return isFinite(x) ? x : null;
    const s = String(x).trim().replace(/\\s+/g,'');
    if (!s) return null;
    const t = s.replace(/\\./g,'').replace(/,/g,'.');
    const v = Number(t);
    return isFinite(v) ? v : null;
  }

  function rateFromTilgung(P, ratePct, tilgPct){
    // Monatsrate aus (Zins + Anfangstilgung) * P / 12
    return ((ratePct/100) + (tilgPct/100)) * P / 12;
  }

  function rateFromMonths(P, ratePct, n){
    const r = (ratePct/100)/12;
    if (r === 0) return P / n;
    const a = r * Math.pow(1+r, n) / (Math.pow(1+r, n) - 1);
    return P * a;
  }

  function buildPlan(P, ratePct, payment, nLimit, start){
    const r = (ratePct/100)/12;
    const rows = [];
    let bal = P;
    let d = start || toMonthStart(new Date());
    let i = 0;
    const nMax = nLimit || 1200;
    for (; i < nMax; i++){
      const interest = bal * r;
      let principalPaid = payment - interest;
      if (principalPaid <= 0){ rows.push({i:i+1, date:d, pay:payment, interest, principal:0, bal}); break; }
      if (principalPaid > bal) principalPaid = bal;
      bal -= principalPaid;
      rows.push({ i:i+1, date:d, pay: interest + principalPaid, interest, principal: principalPaid, bal });
      if (nLimit && i === nLimit-1){ // Stop genau nach N Monaten
        break;
      }
      if (!nLimit && bal <= 1e-6){ i++; break; } // Nur im Plan B bis 0 laufen lassen
      d = addMonths(d, 1);
    }
    return rows;
  }

  function renderRows(rows, tbody){
    tbody.innerHTML = '';
    for (const r of rows){
      const tr = document.createElement('tr');
      function td(t){ const x=document.createElement('td'); x.textContent=t; return x; }
      tr.appendChild(td(String(r.i)));
      tr.appendChild(td(fmtMonth.format(r.date)));
      tr.appendChild(td(fmtEUR(r.pay)));
      tr.appendChild(td(fmtEUR(r.interest)));
      tr.appendChild(td(fmtEUR(r.principal)));
      tr.appendChild(td(fmtEUR(r.bal)));
      tbody.appendChild(tr);
    }
  }

  const btn = document.getElementById('calcBtn');
  const applyBtn = document.getElementById('applyReqBtn');
  btn.addEventListener('click', run);
  applyBtn.addEventListener('click', ()=>{
    const req = applyBtn.getAttribute('data-pay');
    if (!req) return;
    alert('Benötigte Rate übernommen: ' + fmtEUR(Number(req)));
  });

  function run(){
    const P = parseNum(document.getElementById('principal').value);
    const z = parseNum(document.getElementById('rate').value);
    const n = parseNum(document.getElementById('months').value);
    const t = parseNum(document.getElementById('tilgPct').value);
    const startStr = document.getElementById('start').value;
    const start = startStr ? new Date(startStr+'-01') : new Date();

    if (!P || !z || !n || !t){ alert('Bitte Kreditbetrag, Zinssatz, Laufzeit und gewünschten Tilgungssatz angeben.'); return; }

    // A) Plan mit gewünschtem Tilgungssatz, aber N Monate (Restschuld möglich)
    const payTilg = rateFromTilgung(P, z, t);
    const rowsA = buildPlan(P, z, payTilg, Math.round(n), start);
    const restAfterN = rowsA.length ? rowsA[rowsA.length-1].bal : P;

    // B) Plan mit benötigter Rate für N Monate (Restschuld = 0)
    const payReq = rateFromMonths(P, z, Math.round(n));
    const rowsB = buildPlan(P, z, payReq, null, start); // bis 0
    // Schneide Tabelle B optional auf n Monate + letzte Restschuld 0
    // (die buildPlan ohne Limit läuft exakt bis 0)

    const delta = payReq - payTilg;
    const implTilgPct = Math.max(0, (payReq*12/P) - (z/100)) * 100; // in Prozent
    const intReq = rowsB.reduce((s,r)=>s+r.interest,0);

    document.getElementById('kpiRateTilg').textContent = fmtEUR(payTilg);
    document.getElementById('kpiRest').textContent = fmtEUR(restAfterN);
    document.getElementById('kpiRateReq').textContent = fmtEUR(payReq);
    document.getElementById('kpiDelta').textContent = fmtEUR(delta);
    document.getElementById('kpiImplTilg').textContent = implTilgPct.toFixed(3) + ' %';
    document.getElementById('kpiIntReq').textContent = fmtEUR(intReq);

    renderRows(rowsA, document.getElementById('tbodyA'));
    renderRows(rowsB, document.getElementById('tbodyB'));

    applyBtn.disabled = false;
    applyBtn.setAttribute('data-pay', String(payReq));
  }
})();
</script>
</body>
</html>